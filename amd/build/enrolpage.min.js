define(["jquery","core/modal_factory","core/modal_events","core/str","core/config","enrol_payment/spin","core/ajax","core/notification"],function(a,b,c,d,e,f,g,h){var i={mdlstr:void 0,gateway:null,originalCost:void 0,subtotal:void 0,taxPercent:void 0,taxAmount:void 0,instanceid:void 0,prepayToken:void 0,billingAddressRequired:void 0,validateZipCode:void 0,shippingAddressRequired:void 0,userEmail:void 0,currency:void 0,symbol:void 0,discountCodeRequired:void 0,discountThreshold:void 0,MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var b=[];return a(".mr-email-line input").each(function(){var c=a(this).val();""!==a.trim(c)&&b.push(c)}),b},addPlusClickHandler:function(b,c){var d=this;b.click(function(){var b=d.makeEmailEntryLine(c);a(".plus-container").remove();var e=a("#multiple-registration-container").append(b);d.addPlusClickHandler(a(".plus-container"),c),d.addMinusClickHandler(e.find(".minus-container"),c)})},addMinusClickHandler:function(b,c){var d=this;b.click(function(){console.log(a(this).parent()),a(this).parent().parent().remove(),a(".form-group:last .plus-container").length||(a(".form-group:last").append(d.makePlusSign(c)),d.addPlusClickHandler(a(".plus-container"),c)),d.refreshEmailNums()})},makePlusSign:function(a){var b=a.addaregistrant,c='<div class="plus-container mb-2" title="'+b+'"><i style="color: green;" class="icon fa fa-user-plus"></i></div>';return c},makePlusAndMinusSigns:function(a,b){var c=this.makePlusSign(b),d=b.removearegistrant,e='<div class="minus-container mb-2" title="'+d+'"><i style="color: red;" class="icon fa fa-user-times fa-fw"></i></div>';return a>1?c+e:c},refreshEmailNums:function(){var b=-1;return a(".email-num").each(function(c){a(this).text(c+1),b=c}),b+2},makeEmailEntryLine:function(a){var b=this,c=b.refreshEmailNums(),d=b.nextEmailID;b.nextEmailID=b.nextEmailID+1;var e='"multiple-registration-email-'+d+'"',f='<div class="form-inline mr-email-line"><div class="form-group "><label for='+e+' class="mb-2 col-form-label">Email &nbsp; <span class="email-num"> '+c+' </span></label><div class="mb-2 mx-sm-3"><input id='+e+' type="text" class="form-control multiple-registration-email" placeholder="Enter an email address"></div>',g="</div></div>";return f+this.makePlusAndMinusSigns(d,a)+g},checkoutConfirmModal:function(d,e){var f=a("#success-modal-trigger");f.off(),b.create({type:b.types.SAVE_CANCEL,title:d.mdlstr.confirmpurchase,body:e,large:!0},f).done(function(a){a.setSaveButtonText(d.mdlstr["continue"]),a.getRoot().on(c.save,function(){d.checkoutFinal()}),d.removeDimmer(a)}),a("#success-modal-trigger").click()},handleEmailSubmitAJAXResponse:function(b,c){var d=this,e=JSON.parse(b);if(e.success)c.subtotal=e.subtotal,c.updateCostView(),d.checkoutConfirmModal(c,e.successmessage);else{var f=a("#error-modal-trigger");f.off(),c.errorFromEnrollment(e.failmessage)}},verifyAndSubmit:function(b){var c=this;if("paypal"!==b.gateway&&"stripe"!==b.gateway)throw alert(b.mdlstr.invalidpaymentprovider),new Error(b.mdlstr.invlidpaymentprovider);var d=c.getEmails();d.length?(a("div.enrol-payment-enrollment").hide(),g.call([{methodname:"enrol_payment_multiple_enrollment",args:{enrolid:b.instanceid,prepaytoken:b.prepayToken,emails:JSON.stringify(d),ipnid:a("#"+b.gateway+"-custom").val(),symbol:b.symbol},done:function(a){c.handleEmailSubmitAJAXResponse(a,b)}.bind(this),fail:h.exception}])):(b.genericErrorModal(b.mdlstr.novalidemailsentered,b.mdlstr.novalidemailsentered_desc,"no-valid-emails-entered"),a("#dimmer").css("display","none"))},buildForm:function(c,d,e){var f=this;f.enabled?(a("#dimmer").css("display","block"),f.enabled=!1,c.text(d.enrolothers),c.removeClass("disable-mr").addClass("enable-mr"),a(".mr-email-line").remove(),a("#multiple-registration-btn-container img.iconhelp").css("display","inline-block"),g.call([{methodname:"enrol_payment_single_enrollment",args:{enrolid:e.instanceid,prepaytoken:e.prepayToken},done:function(c){var d=JSON.parse(c);if(a("#dimmer").css("display","none"),d.success)e.subtotal=d.subtotal,e.updateCostView();else{var f=a("#error-modal-trigger");f.off(),b.create({type:b.types.DEFAULT,body:d.failmessage,closebuttontitle:e.mdlstr.dismiss,large:!0},f).done(function(a){e.removeDimmer(a)}),a("#error-modal-trigger").click()}}.bind(this),fail:h.exception}])):(f.enabled=!0,f.nextEmailID=1,c.text(d.cancelenrolothers),c.removeClass("enable-mr").addClass("disable-mr"),a("#multiple-registration-container").html(this.makeEmailEntryLine(d)),f.addPlusClickHandler(a(".plus-container"),d),a("#multiple-registration-btn-container img.iconhelp").css("display","none"))}},Discount:{checkDiscountCode:function(b){var c=a("#discountcode").val();a("span.discount-threshold-info").hide(),a("div.enrol-payment-error-text").hide(),g.call([{methodname:"enrol_payment_check_discount",args:{enrolid:b.instanceid,prepaytoken:b.prepayToken,discountcode:c},done:function(c){var d=JSON.parse(c);d.error?b.errorFromDiscount(d.errormsg):(a("#discount-container").hide(),b.subtotal=d.subtotal,b.updateCostView(),a(".discount-threshold-info").css("display","block"))}.bind(this),fail:h.exception}])}},checkoutFinal:function(){if(this.updateCostView(),"paypal"===this.gateway)a("#paypal-form input[name=amount]").val(this.subtotal),a("#paypal-form input[name=tax]").val(this.taxAmount),a("#paypal-form").submit();else{if("stripe"!==this.gateway)throw new Error(this.mdlstr.invalidgateway);a("#stripe-form input[name=amount]").val(this.getTaxedAmount()),a("#stripe-form input[name=tax]").val(this.taxAmount),this.stripeCheckout()}},getTaxedAmount:function(){return(parseFloat(this.subtotal)+parseFloat(this.taxAmount)).toFixed(2)},errorFromDiscount:function(b){a("span.discount-threshold-info").hide(),a("div.enrol-payment-error-text").show(),a("div.enrol-payment-error-text").text(b)},errorFromEnrollment:function(b){a("div.enrol-payment-enrollment").show(),a("div.enrol-payment-enrollment").html(b)},updateCostView:function(){this.taxAmount=Number.parseFloat(this.subtotal*this.taxPercent).toFixed(2),a("span.localisedcost-untaxed").text(Number.parseFloat(this.subtotal).toFixed(2)),a("span.localisedcost").text(this.getTaxedAmount()),a("span.subtotal-display").text(this.getTaxedAmount()),Number.parseFloat(this.taxAmount).toFixed(0)>0?a("span.taxamountstring").text(Number.parseFloat(this.taxAmount).toFixed(2)):a("span.tax-container").hide(),a("span.taxamountstring").text(Number.parseFloat(this.taxAmount).toFixed(2)),a("span#banktransfer-cost").text(this.symbol+this.getTaxedAmount())},stripeCheckout:function(){var b=this;a.getScript("https://checkout.stripe.com/checkout.js",function(){var c=StripeCheckout.configure({key:b.stripePublishableKey,image:b.stripeLogo||"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",billingAddress:b.billingAddressRequired,shippingAddress:b.shippingAddressRequired,email:b.userEmail||null,allowRememberMe:!1,token:function(b){a("#stripe-form").append('<input type="hidden" name="stripeToken" value="'+b.id+'" />').append('<input type="hidden" name="stripeTokenType" value="'+b.type+'" />').append('<input type="hidden" name="stripeEmail" value="'+b.email+'" />').submit()}});c.open({name:decodeURIComponent(b.courseFullName),description:b.mdlstr.totalenrolmentfee+" "+b.symbol+b.getTaxedAmount()+" "+b.currency,zipCode:b.validateZipCode?"true":"false",amount:Math.floor(100*Number.parseFloat(b.getTaxedAmount())),currency:b.currency,closed:function(){a("#dimmer").css("display","none")}})}).fail(function(){throw new Error("Could not load Stripe checkout library.")})},genericErrorModal:function(c,d,e){var f=this;0==a("#"+e).length&&a("#moodle-modals").append('<a id="'+e+'"></a>');var g=a("#moodle-modals #"+e);g.off(),b.create({type:b.types.DEFAULT,title:c,body:d},g).done(function(a){f.removeDimmer(a)}),g.click()},removeDimmer:function(b){b.getRoot().on(c.destroyed,function(){a("#dimmer").css("display","none")}),b.getRoot().on(c.cancel,function(){a("#dimmer").css("display","none")}),b.getRoot().on(c.hidden,function(){a("#dimmer").css("display","none")})},initClickHandlers:function(){var b=this;a("#apply-discount").click(function(){b.Discount.checkDiscountCode(b)}),a("#multiple-registration-btn").click(function(){b.MultipleRegistration.buildForm(a(this),b.mdlstr,b)}),a(".payment-checkout").click(function(c){a("#dimmer").css("display","block"),c.preventDefault(),"paypal-button"===c.target.id?b.gateway="paypal":"stripe-button"===c.target.id&&(b.gateway="stripe"),b.MultipleRegistration.enabled?b.MultipleRegistration.verifyAndSubmit(b):b.checkoutFinal()})},loadStrings:function(a,b){for(var c=[],e=0;e<a.length;e++)c.push({key:a[e],component:"enrol_payment"});var f=d.get_strings(c);f.done(function(c){for(var d=[],e=0;e<a.length;e++)d[a[e]]=c[e];b(d)})},init:function(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r=this,s=["discounttypeerror","discountamounterror","invalidgateway","errcommunicating","addaregistrant","removearegistrant","enrolothers","cancelenrolothers","confirmpurchase","continue","dismiss","invalidpaymentprovider","novalidemailsentered","novalidemailsentered_desc","totalenrolmentfee","error","incorrectdiscountcode","incorrectdiscountcode_desc"];r.loadStrings(s,function(s){r.mdlstr=s,r.originalCost=parseFloat(d),r.taxPercent=parseFloat(i),r.subtotal=parseFloat(j),r.taxAmount=parseFloat(i*d),r.instanceid=b,r.stripePublishableKey=c,r.courseFullName=f,r.shippingAddressRequired=1==g,r.prepayToken=e,r.stripeLogo=h,r.validateZipCode=1==k,r.billingAddressRequired=1==l,r.userEmail=m,r.currency=n,r.symbol=o,r.discountCodeRequired=1==p,r.discountThreshold=q,r.initClickHandlers(),r.updateCostView(),a("#dimmer").css("display","none")})}};return i});